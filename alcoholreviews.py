# -*- coding: utf-8 -*-
"""AlcoholReviews

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1rbRPgvbrl2K1WP4FrwLRbgq0HSkfgBSe
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import re

# è®¾ç½®é¡µé¢é…ç½®
st.set_page_config(page_title="é…’ç²¾ç¬”è¯„è®ºé—­ç¯åˆ†æ", layout="wide")

# --- 1. FEATURE_KEYWORDS è¯åº“ (å·²åŒ…å«ä½ æä¾›çš„ç²¾ç»†è¯æ±‡) ---
FEATURE_KEYWORDS = {
    'é¢œè‰²ç§ç±»': {
        'æ­£é¢': ['many colors', 'lot of colors', 'plenty of colors', 'good range', 'great variety', 'great selection', 'every color', 'all the colors', 'so many options', 'love the large set', 'great number of colors', 'perfect amount of colors', 'huge set of 72', 'full set is amazing', 'good assortment', 'great color selection', 'perfect pastel set', 'good range of skin tones', 'well-curated palette', 'love the color story', 'beautiful assortment of colors', 'has every color I need'],
        'è´Ÿé¢': ['limited range', 'not enough colors', 'wish for more', 'missing colors', 'disappointed with selection', 'needs more colors', 'wish for a smaller set', 'too many colors', 'no smaller option', 'forced to buy the large set', 'have to buy the whole set', 'missing key colors', 'no true red', 'needs more grays', 'too many similar colors', 'palette is not useful', 'wish it had more pastels', 'poor color selection', 'needs more skin tones']
    },
    'ç¬”å¤´è¡¨ç°': {
        'æ­£é¢': ['love the dual tip', 'love the two tips', 'love that it has two sides', 'love the dual nibs', 'great having two tips', 'useful dual tip', 'handy dual tip', 'convenient to have two tips', 'love the brush and fine tip combo', 'love the brush tip', 'great brush nib', 'flexible brush tip', 'soft brush tip', 'love the fine tip', 'precise fine liner', 'perfect for details', 'sharp chisel edge', 'sturdy bullet tip'],
        'è´Ÿé¢': ['useless dual tip', 'redundant dual tip', "don't need the dual tip", 'only use one side', 'brush tip frays', 'brush tip split', 'brush tip wore out', 'fine tip is scratchy', 'fine tip dried out', 'chisel tip is too broad', 'chisel tip is too thick', 'too stiff', 'too firm', 'too soft', 'mushy', 'fray', 'fraying', 'split']
    },
    'æµç•…æ€§ä¸å¢¨æ°´': {
        'æ­£é¢': ['writes smoothly', 'buttery smooth', 'glides across the page', 'consistent ink flow', 'no skipping', 'no bleed-through', 'zero bleed', 'no ghosting', 'quick dry', 'dry so fast', 'non-toxic', 'no smell', 'odorless', 'no smear', 'smudge proof'],
        'è´Ÿé¢': ['scratchy', 'feels scratchy', 'writes dry', 'arrived dried out', 'skips', 'skipping', 'ink skips', 'hard start', 'bleeds through', 'bleed-through is bad', 'ghosting is terrible', 'smears easily', 'smudges easily', 'bad smell', 'strong smell', 'toxic smell', 'leaks', 'leaking ink']
    }
}

# --- 2. æ ¸å¿ƒé€»è¾‘å‡½æ•° ---
def analyze_closed_loop_with_lexicon(df, keywords):
    # è‡ªåŠ¨è¯†åˆ«åˆ—åï¼ˆé˜²æ­¢å¤§å°å†™å‘ï¼‰
    # æ£€æŸ¥ Title å’Œ Review Content æ˜¯å¦å­˜åœ¨
    cols = {c.lower(): c for c in df.columns}
    title_col = cols.get('title', 'Title')
    review_col = cols.get('review content', 'Review Content')
    sales_col = cols.get('average monthly sales', 'Average Monthly sales')

    all_pos_phrases = [p for cat in FEATURE_KEYWORDS.values() for p in cat.get('æ­£é¢', [])]
    all_neg_phrases = [p for cat in FEATURE_KEYWORDS.values() for p in cat.get('è´Ÿé¢', [])]

    pos_regex = re.compile(r'\b(' + '|'.join(map(re.escape, all_pos_phrases)) + r')\b', re.IGNORECASE)
    neg_regex = re.compile(r'\b(' + '|'.join(map(re.escape, all_neg_phrases)) + r')\b', re.IGNORECASE)

    results = []
    for kw in keywords:
        # ä¿®æ”¹å¤„ï¼šä½¿ç”¨ title_col å˜é‡
        mask = df[title_col].str.contains(kw, case=False, na=False)
        sub_df = df[mask].copy()
        if sub_df.empty: continue

        total_reviews = len(sub_df)
        # ä¿®æ”¹å¤„ï¼šä½¿ç”¨ review_col å˜é‡
        mention_mask = sub_df[review_col].str.contains(kw, case=False, na=False)
        mention_count = mention_mask.sum()
        mention_rate = (mention_count / total_reviews) * 100 if total_reviews > 0 else 0

        relevant_reviews = sub_df[mention_mask][review_col].astype(str)
        pos_hits = relevant_reviews.apply(lambda x: len(pos_regex.findall(x))).sum()
        neg_hits = relevant_reviews.apply(lambda x: len(neg_regex.findall(x))).sum()

        sentiment_score = (pos_hits - neg_hits) / (pos_hits + neg_hits + 1e-6)

        results.append({
            "å…³é”®è¯": kw,
            "å¿ƒæ™ºæåŠç‡(%)": round(mention_rate, 2),
            "æƒ…æ„Ÿæ­£å‘æŒ‡æ•°": round(sentiment_score, 3),
            "å…³è”äº§å“æœˆé”€é‡": int(pd.to_numeric(sub_df[sales_col], errors='coerce').sum()),
            "æ ·æœ¬è¯„è®ºé‡": total_reviews,
            "æ­£é¢è¯å‘½ä¸­": pos_hits,
            "è´Ÿé¢è¯å‘½ä¸­": neg_hits
        })
    return pd.DataFrame(results)

# --- 3. Streamlit UI å¸ƒå±€ ---
st.title("ğŸ–Œï¸ é…’ç²¾ç¬”å–ç‚¹é—­ç¯åé¦ˆåˆ†æç³»ç»Ÿ")

# ä¾§è¾¹æ ï¼šæ–‡ä»¶ä¸Šä¼ 
st.sidebar.header("æ•°æ®ä¸Šä¼ ")
uploaded_file = st.sidebar.file_uploader("ä¸Šä¼ æ‚¨çš„è¯„è®ºæ•°æ® (XLSX æˆ– CSV)", type=["xlsx", "csv"])

if uploaded_file:
    # è‡ªåŠ¨æ ¹æ®æ–‡ä»¶åç¼€è¯†åˆ«è¯»å–æ–¹å¼
    if uploaded_file.name.endswith('.csv'):
        df = pd.read_csv(uploaded_file)
    else:
        # ç¡®ä¿å®‰è£…äº† openpyxl åº“ï¼špip install openpyxl
        df = pd.read_excel(uploaded_file)

    # ä¾§è¾¹æ ï¼šå…³é”®è¯è®¾ç½®
    st.sidebar.header("åˆ†æè®¾ç½®")
    default_keywords = ['Brush Tip', 'Colors', 'Alcohol', 'Refillable', 'Dual Tip', 'Bleed', 'Blend']
    selected_kws = st.sidebar.multiselect("é€‰æ‹©æˆ–è¾“å…¥è¦åˆ†æçš„æ ‡é¢˜å…³é”®è¯", default_keywords, default=default_keywords)

    if selected_kws:
        res_df = analyze_closed_loop_with_lexicon(df, selected_kws)

        if not res_df.empty:
            # å›¾è¡¨å±•ç¤º
            st.subheader("ğŸ”„ å–ç‚¹é—­ç¯å½’å› å›¾è°±")
            fig = px.scatter(res_df,
                             x="å¿ƒæ™ºæåŠç‡(%)",
                             y="æƒ…æ„Ÿæ­£å‘æŒ‡æ•°",
                             size="å…³è”äº§å“æœˆé”€é‡",
                             color="å…³é”®è¯",
                             text="å…³é”®è¯",
                             hover_data=["æ­£é¢è¯å‘½ä¸­", "è´Ÿé¢è¯å‘½ä¸­", "æ ·æœ¬è¯„è®ºé‡"],
                             range_y=[-1.1, 1.1])

            fig.add_hline(y=0, line_dash="solid", line_color="black")
            fig.add_vline(x=res_df['å¿ƒæ™ºæåŠç‡(%)'].mean(), line_dash="dash", annotation_text="å¹³å‡æåŠç‡")

            fig.update_layout(height=600)
            st.plotly_chart(fig, use_container_width=True)

            # è¯¦ç»†è¡¨æ ¼
            st.subheader("ğŸ“Š è¯¦ç»†ç»´åº¦æŒ‡æ ‡")
            st.dataframe(res_df.sort_values("å¿ƒæ™ºæåŠç‡(%)", ascending=False), use_container_width=True)
        else:
            st.warning("æ‰€é€‰å…³é”®è¯åœ¨æ•°æ®ä¸­æœªåŒ¹é…åˆ°ç»“æœã€‚")
else:
    st.info("ğŸ‘‹ è¯·åœ¨å·¦ä¾§ä¸Šä¼ è¯„è®ºæ•°æ® CSV æ–‡ä»¶å¼€å§‹åˆ†æã€‚")
